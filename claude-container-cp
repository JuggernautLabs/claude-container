#!/bin/bash
# Copy files to/from a claude-container session volume
#
# Usage:
#   claude-container-cp <session>:<path> <local-path>   # Copy from session
#   claude-container-cp <local-path> <session>:<path>   # Copy to session
#   claude-container-cp --list <session> [path]         # List files in session
#
# Examples:
#   claude-container-cp feature:/workspace/build ./build
#   claude-container-cp ./config.json feature:/workspace/config.json
#   claude-container-cp --list feature /workspace

set -e

VERSION="0.1.0"
DEFAULT_IMAGE="ghcr.io/hypermemetic/claude-container:latest"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${BLUE}→${NC} $*"; }
success() { echo -e "${GREEN}✓${NC} $*"; }
warn() { echo -e "${YELLOW}⚠${NC} $*"; }
error() { echo -e "${RED}✗${NC} $*" >&2; }

usage() {
    cat <<EOF
Usage: claude-container-cp [options] <source> <dest>

Copy files to/from a claude-container session volume.

Syntax:
  <session>:<path>    Path inside a session volume
  <local-path>        Path on the host filesystem

Options:
  --list, -l <session> [path]  List files in session (default path: /workspace)
  --recursive, -r              Copy directories recursively (default: true)
  --help, -h                   Show this help
  --version, -V                Show version

Examples:
  # Copy from session to local
  claude-container-cp feature:/workspace/dist ./dist
  claude-container-cp feature:/workspace/report.pdf .

  # Copy from local to session
  claude-container-cp ./fixtures feature:/workspace/test/fixtures
  claude-container-cp .env feature:/workspace/.env

  # List files in session
  claude-container-cp --list feature
  claude-container-cp --list feature /workspace/src

  # Copy home directory artifacts
  claude-container-cp feature:/home/developer/.cargo/registry ./cargo-cache

Volume locations:
  /workspace              Git session working directory
  /home/developer/.claude Claude state and conversation history
  /home/developer/.cargo  Cargo cache
  /home/developer/.npm    npm cache
EOF
    exit 0
}

# Parse session:path syntax
parse_session_path() {
    local input="$1"
    if [[ "$input" == *:/* ]]; then
        SESSION_NAME="${input%%:*}"
        SESSION_PATH="${input#*:}"
        return 0
    fi
    return 1
}

# Get the volume name for a session path
get_volume_for_path() {
    local session="$1"
    local path="$2"

    case "$path" in
        /workspace|/workspace/*)
            echo "claude-session-${session}"
            ;;
        /home/developer/.claude|/home/developer/.claude/*)
            echo "claude-state-${session}"
            ;;
        /home/developer/.cargo|/home/developer/.cargo/*)
            echo "claude-cargo-${session}"
            ;;
        /home/developer/.npm|/home/developer/.npm/*)
            echo "claude-npm-${session}"
            ;;
        /home/developer/.cache/pip|/home/developer/.cache/pip/*)
            echo "claude-pip-${session}"
            ;;
        *)
            error "Unknown path: $path"
            echo "Supported paths:"
            echo "  /workspace/*"
            echo "  /home/developer/.claude/*"
            echo "  /home/developer/.cargo/*"
            echo "  /home/developer/.npm/*"
            echo "  /home/developer/.cache/pip/*"
            exit 1
            ;;
    esac
}

# Get the path relative to the volume mount point
get_relative_path() {
    local path="$1"

    case "$path" in
        /workspace)
            echo "."
            ;;
        /workspace/*)
            echo "${path#/workspace/}"
            ;;
        /home/developer/.claude)
            echo "."
            ;;
        /home/developer/.claude/*)
            echo "${path#/home/developer/.claude/}"
            ;;
        /home/developer/.cargo)
            echo "."
            ;;
        /home/developer/.cargo/*)
            echo "${path#/home/developer/.cargo/}"
            ;;
        /home/developer/.npm)
            echo "."
            ;;
        /home/developer/.npm/*)
            echo "${path#/home/developer/.npm/}"
            ;;
        /home/developer/.cache/pip)
            echo "."
            ;;
        /home/developer/.cache/pip/*)
            echo "${path#/home/developer/.cache/pip/}"
            ;;
        *)
            echo "$path"
            ;;
    esac
}

# List files in a session
list_session() {
    local session="$1"
    local path="${2:-/workspace}"

    local volume
    volume=$(get_volume_for_path "$session" "$path")

    # Check if volume exists
    if ! docker volume inspect "$volume" &>/dev/null; then
        error "Session volume not found: $volume"
        echo ""
        echo "Available sessions:"
        docker volume ls -q | grep -E "^claude-session-" | sed 's/^claude-session-/  /' || echo "  (none)"
        exit 1
    fi

    local rel_path
    rel_path=$(get_relative_path "$path")

    info "Listing $path in session '$session' (volume: $volume)"
    echo ""

    docker run --rm \
        -v "$volume:/mnt/volume:ro" \
        alpine \
        ls -la "/mnt/volume/$rel_path"
}

# Copy from session to local
copy_from_session() {
    local session="$1"
    local session_path="$2"
    local local_path="$3"

    local volume
    volume=$(get_volume_for_path "$session" "$session_path")

    # Check if volume exists
    if ! docker volume inspect "$volume" &>/dev/null; then
        error "Session volume not found: $volume"
        exit 1
    fi

    local rel_path
    rel_path=$(get_relative_path "$session_path")

    info "Copying from session '$session'"
    echo "  Source: $session_path"
    echo "  Dest:   $local_path"
    echo "  Volume: $volume"
    echo ""

    # Create a temporary container to copy from
    local container_id
    container_id=$(docker create -v "$volume:/mnt/volume:ro" alpine true)

    # Copy the files
    if docker cp "$container_id:/mnt/volume/$rel_path" "$local_path"; then
        success "Copy complete"
    else
        error "Copy failed"
        docker rm "$container_id" >/dev/null 2>&1
        exit 1
    fi

    # Clean up
    docker rm "$container_id" >/dev/null 2>&1
}

# Copy from local to session
copy_to_session() {
    local local_path="$1"
    local session="$2"
    local session_path="$3"

    local volume
    volume=$(get_volume_for_path "$session" "$session_path")

    # Check if volume exists
    if ! docker volume inspect "$volume" &>/dev/null; then
        error "Session volume not found: $volume"
        exit 1
    fi

    # Check if local path exists
    if [[ ! -e "$local_path" ]]; then
        error "Local path not found: $local_path"
        exit 1
    fi

    local rel_path
    rel_path=$(get_relative_path "$session_path")

    info "Copying to session '$session'"
    echo "  Source: $local_path"
    echo "  Dest:   $session_path"
    echo "  Volume: $volume"
    echo ""

    # Create a temporary container to copy to
    local container_id
    container_id=$(docker create -v "$volume:/mnt/volume" alpine true)

    # Ensure parent directory exists
    local parent_dir
    parent_dir=$(dirname "/mnt/volume/$rel_path")
    docker run --rm -v "$volume:/mnt/volume" alpine mkdir -p "$parent_dir" 2>/dev/null || true

    # Copy the files
    if docker cp "$local_path" "$container_id:/mnt/volume/$rel_path"; then
        success "Copy complete"
    else
        error "Copy failed"
        docker rm "$container_id" >/dev/null 2>&1
        exit 1
    fi

    # Clean up
    docker rm "$container_id" >/dev/null 2>&1
}

# Main
case "${1:-}" in
    --help|-h)
        usage
        ;;
    --version|-V)
        echo "claude-container-cp $VERSION"
        exit 0
        ;;
    --list|-l)
        if [[ -z "${2:-}" ]]; then
            error "--list requires a session name"
            exit 1
        fi
        list_session "$2" "${3:-/workspace}"
        exit 0
        ;;
esac

# Need exactly 2 arguments for copy
if [[ $# -ne 2 ]]; then
    error "Expected 2 arguments: <source> <dest>"
    echo "Run 'claude-container-cp --help' for usage"
    exit 1
fi

SOURCE="$1"
DEST="$2"

# Determine direction of copy
if parse_session_path "$SOURCE"; then
    # Source is session:path
    FROM_SESSION="$SESSION_NAME"
    FROM_PATH="$SESSION_PATH"

    if parse_session_path "$DEST"; then
        error "Cannot copy between sessions directly"
        echo "Copy to local first, then to the other session"
        exit 1
    fi

    copy_from_session "$FROM_SESSION" "$FROM_PATH" "$DEST"

elif parse_session_path "$DEST"; then
    # Dest is session:path
    TO_SESSION="$SESSION_NAME"
    TO_PATH="$SESSION_PATH"

    copy_to_session "$SOURCE" "$TO_SESSION" "$TO_PATH"

else
    error "Neither source nor dest is a session path"
    echo "Use <session>:<path> syntax, e.g., 'feature:/workspace/file.txt'"
    exit 1
fi

#!/usr/bin/env bash
# Spawn into a Docker container with Claude Code ready to execute
#
# Usage:
#   claude-container [dockerfile] [--build] [--dir <path>]
#   claude-container                    # Use ./Dockerfile or ./.devcontainer/Dockerfile
#   claude-container path/to/Dockerfile # Use specific Dockerfile
#   claude-container --build            # Force rebuild image
#   claude-container --dir ./myproject  # Use overlay for myproject directory
#
# Environment:
#   CLAUDE_CODE_OAUTH_TOKEN  OAuth token for authentication (required)

set -e

VERSION="0.1.0"
DEFAULT_IMAGE="ghcr.io/hypermemetic/claude-container:latest"

# Config and cache directories
CONFIG_DIR="$HOME/.config/claude-container"
CACHE_DIR="$CONFIG_DIR/cache"

# Ensure directories exist
mkdir -p "$CONFIG_DIR" "$CACHE_DIR"
chmod 700 "$CONFIG_DIR"

# Source library modules (resolve symlinks to find actual script location)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0" 2>/dev/null || realpath "$0" 2>/dev/null || echo "$0")")" && pwd)"
source "$SCRIPT_DIR/lib/utils.sh"
source "$SCRIPT_DIR/lib/platform.sh"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/auth.sh"
source "$SCRIPT_DIR/lib/docker.sh"
source "$SCRIPT_DIR/lib/git-session.sh"
source "$SCRIPT_DIR/lib/git-ops.sh"
source "$SCRIPT_DIR/lib/session-mgmt.sh"

# Global state variables
DOCKERFILE=""
FORCE_BUILD=false
FORCE_DEFAULT_IMAGE=false
SESSION_DIR=""
VERIFY_MODE=false
SESSION_NAME="default"
SESSION_NAME_SET=false
GIT_SESSION=""
USE_GIT_SESSION=false
CONTINUE_SESSION=false
RUN_AS_USER=false
RUN_AS_ROOTISH=true  # Default: run as user with fake-root for package installs
AUTO_SYNC_BRANCH=""
NO_RUN=false
SHELL_ONLY=false
DISCOVER_REPOS_DIRS=()  # Array for multiple --discover-repos

# Docker args accumulator
declare -a DOCKER_ARGS

# Handle cleanup commands (before main argument parsing)
case "${1:-}" in
    --cleanup)
        session_cleanup
        exit 0
        ;;

    --cleanup-unused)
        shift
        session_cleanup_unused "$@"
        exit 0
        ;;

    --list-sessions|--sessions)
        session_list
        exit 0
        ;;

    --delete-session)
        shift
        session_delete "$@"
        exit 0
        ;;

    --restart-session)
        shift
        session_restart "$@"
        exit 0
        ;;

    --diff-session)
        session_diff "$2" "$(pwd)" "${3:-}"
        exit 0
        ;;

    --merge-session)
        shift
        session_merge "$@"
        exit 0
        ;;

    --add-repo)
        # Usage: --add-repo <session> <repo-path> [workspace-path]
        shift
        session_add_repo "$@"
        exit 0
        ;;
esac

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --build|-b)
            FORCE_BUILD=true
            shift
            ;;
        --default-image)
            FORCE_DEFAULT_IMAGE=true
            shift
            ;;
        --dir|-d)
            SESSION_DIR="$2"
            shift 2
            ;;
        --verify|-v)
            VERIFY_MODE=true
            shift
            ;;
        --session|-s)
            SESSION_NAME="$2"
            SESSION_NAME_SET=true
            shift 2
            ;;
        --git-session|-g)
            GIT_SESSION="$2"
            USE_GIT_SESSION=true
            shift 2
            ;;
        --continue|-c)
            CONTINUE_SESSION=true
            shift
            ;;
        --as-user)
            RUN_AS_USER=true
            shift
            ;;
        --as-rootish)
            RUN_AS_ROOTISH=true
            shift
            ;;
        --as-root|--no-rootish)
            RUN_AS_ROOTISH=false
            RUN_AS_USER=false
            shift
            ;;
        --auto-sync)
            AUTO_SYNC_BRANCH="$2"
            shift 2
            ;;
        --discover-repos)
            DISCOVER_REPOS_DIRS+=("$2")
            shift 2
            ;;
        --config|-C)
            CONFIG_FILE="$2"
            shift 2
            ;;
        --no-run)
            NO_RUN=true
            shift
            ;;
        --shell|--bash)
            SHELL_ONLY=true
            shift
            ;;
        --version|-V)
            echo "claude-container $VERSION"
            exit 0
            ;;
        --help|-h)
            cat <<EOF
Usage: claude-container [options] [dockerfile]

Spawn into a Docker container with Claude Code ready.

Options:
  --build, -b              Force rebuild the image
  --default-image          Use default image (skip local Dockerfile)
  --dir, -d <path>         Directory to use with overlay (changes persist in session volume)
                           DEPRECATED: Use --git-session instead (requires --privileged)
  --git-session, -g <name> Create/resume a git-based isolated session (recommended)
  --session, -s <name>     Override session name for state persistence (default: "default")
  --continue, -c           Continue the most recent Claude conversation
  --as-user                Run as non-root developer user (no fake-root)
  --as-rootish             Run as developer with fake-root for installs (default)
  --as-root, --no-rootish  Run as actual root user
  --auto-sync <branch>     Auto-merge session commits to branch on exit
  --discover-repos <dir>   Auto-discover all git repos in directory
  --config, -C <path>      Explicit path to .claude-projects.yml config file
  --verify, -v             Verify container setup works (run checks and exit)
  --shell, --bash          Start bash shell instead of claude
  --version, -V            Show version
  --help, -h               Show this help

Session Management:
  --cleanup                List and optionally delete all claude-related volumes
  --cleanup-unused [--yes] Delete volumes not used by running containers
  --list-sessions, --sessions  List all sessions with disk usage per volume
  --delete-session <name> [--regex] [--yes]  Delete session(s) with confirmation
  --restart-session <name> Restart a session (fixes permissions, continues conversation)
  --diff-session <name>    Show changes made in a git session vs original repo
  --merge-session <name>   Merge session commits back to repo
  --add-repo <session> <path> [name]  Add a repo to an existing session

Environment:
  CLAUDE_CODE_OAUTH_TOKEN   OAuth token for authentication (required)
                            Get one with: claude setup-token

Examples:
  claude-container                        # Start with current dir mounted
  claude-container --git-session feature  # Start git session "feature"
  claude-container -g feature --continue  # Resume session AND continue conversation
EOF
            exit 0
            ;;
        *)
            DOCKERFILE="$1"
            shift
            ;;
    esac
done

# If using git session and session name wasn't explicitly set, use git session name
if $USE_GIT_SESSION && ! $SESSION_NAME_SET; then
    SESSION_NAME="$GIT_SESSION"
fi

# Ensure token is available (from config, keychain, or interactive auth)
ensure_token

# Check for YAML parser if we'll need it (multi-project mode)
if $USE_GIT_SESSION || [[ -n "$CONFIG_FILE" ]]; then
    will_use_config=false
    if [[ -n "$CONFIG_FILE" ]]; then
        will_use_config=true
    elif $USE_GIT_SESSION; then
        workspace="${WORKSPACE_DIR:-$(pwd)}"
        for candidate in \
            "$workspace/.claude-projects.yml" \
            "$workspace/.devcontainer/claude-projects.yml" \
            "$workspace/claude-projects.yml"; do
            if [[ -f "$candidate" ]]; then
                will_use_config=true
                break
            fi
        done
    fi

    if $will_use_config && ! check_yaml_parser_available; then
        echo ""
        warn "Multi-project config detected but YAML parser not available"
        show_yaml_parser_install_help
        exit 1
    fi
fi

# Find Dockerfile
if [[ -z "$DOCKERFILE" ]]; then
    for candidate in "./Dockerfile" "./.devcontainer/Dockerfile" "./docker/Dockerfile"; do
        if [[ -f "$candidate" ]]; then
            DOCKERFILE="$candidate"
            break
        fi
    done
fi

USE_DEFAULT_IMAGE=false

if $FORCE_DEFAULT_IMAGE; then
    info "Using default image (--default-image): $DEFAULT_IMAGE"
    USE_DEFAULT_IMAGE=true
    IMAGE_NAME="$DEFAULT_IMAGE"
    DOCKERFILE=""
elif [[ -z "$DOCKERFILE" ]]; then
    info "No Dockerfile found, using default image: $DEFAULT_IMAGE"
    USE_DEFAULT_IMAGE=true
    IMAGE_NAME="$DEFAULT_IMAGE"
elif [[ ! -f "$DOCKERFILE" ]]; then
    error "Dockerfile not found: $DOCKERFILE"
    exit 1
fi

if $USE_DEFAULT_IMAGE; then
    IMAGE_EXISTS=$(docker images -q "$IMAGE_NAME" 2>/dev/null)
    if [[ -z "$IMAGE_EXISTS" ]] || $FORCE_BUILD; then
        info "Pulling image: $IMAGE_NAME"
        docker pull "$IMAGE_NAME" &
        spin $!
        wait $!
        success "Image pulled: $IMAGE_NAME"
        echo ""
    fi
else
    info "Using Dockerfile: $DOCKERFILE"
    CONTEXT_DIR="$(dirname "$DOCKERFILE")"
    if [[ "$CONTEXT_DIR" == "." ]]; then
        CONTEXT_DIR="$(pwd)"
    fi
    PROJECT_NAME="$(basename "$(pwd)" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-')"
    IMAGE_NAME="claude-dev-${PROJECT_NAME}"

    IMAGE_EXISTS=$(docker images -q "$IMAGE_NAME" 2>/dev/null)
    if [[ -z "$IMAGE_EXISTS" ]] || $FORCE_BUILD; then
        info "Building image: $IMAGE_NAME"
        docker build -t "$IMAGE_NAME" -f "$DOCKERFILE" "$CONTEXT_DIR" &
        spin $!
        wait $!
        success "Image built: $IMAGE_NAME"
        echo ""
    fi
fi

# Prepare mount points
WORKSPACE_DIR="$(pwd)"
USE_OVERLAY=false

# Handle session directory with overlay (deprecated)
SESSION_VOLUME=""
if [[ -n "$SESSION_DIR" ]]; then
    warn "The --dir option is deprecated. Consider using --git-session instead."
    SESSION_DIR="$(cd "$SESSION_DIR" && pwd)"
    SESSION_UUID="$(uuidgen | tr '[:upper:]' '[:lower:]')"
    SESSION_VOLUME="session-data-${SESSION_UUID}"
    info "Creating session volume: $SESSION_VOLUME"
    docker volume create "$SESSION_VOLUME" >/dev/null
    USE_OVERLAY=true
    WORKSPACE_DIR="$SESSION_DIR"
fi

# Handle git-based session isolation (recommended)
GIT_SESSION_VOLUME=""
if $USE_GIT_SESSION; then
    GIT_SESSION_VOLUME="claude-session-${GIT_SESSION}"
    create_git_session "$GIT_SESSION" "$WORKSPACE_DIR"

    if $NO_RUN; then
        success "Session ready: $GIT_SESSION"
        exit 0
    fi
fi

# Build docker run command
DOCKER_ARGS=(
    "--rm"
    "--name" "claude-dev-$$"
    "-w" "/workspace"
)

# Add TTY based on CI detection and terminal availability
if $IS_CI; then
    :
elif ! $VERIFY_MODE && [[ -t 0 ]]; then
    DOCKER_ARGS+=("-it")
fi

# Mount workspace
if $USE_GIT_SESSION; then
    DOCKER_ARGS+=("-v" "$GIT_SESSION_VOLUME:/workspace")
elif $USE_OVERLAY; then
    DOCKER_ARGS+=(
        "--privileged"
        "--device" "/dev/fuse"
        "-v" "$WORKSPACE_DIR:/workspace-lower:ro"
        "-v" "$SESSION_VOLUME:/session-data"
        "-e" "USE_OVERLAY=1"
        "-e" "SESSION_VOLUME=$SESSION_VOLUME"
    )
else
    DOCKER_ARGS+=("-v" "$WORKSPACE_DIR:/workspace")
fi

# Mount git config and SSH
DOCKER_ARGS+=(
    "-v" "$HOME/.gitconfig:/root/.gitconfig:ro"
    "-v" "$HOME/.ssh:/root/.ssh:ro"
)

# Forward SSH agent if available
SSH_SOCKET_ARGS=$(get_ssh_socket_args)
if [[ -n "$SSH_SOCKET_ARGS" ]]; then
    # shellcheck disable=SC2086
    DOCKER_ARGS+=($SSH_SOCKET_ARGS)
fi

# Add environment variables
DOCKER_ARGS+=(
    "-e" "TERM=${TERM:-xterm-256color}"
    "-e" "HOST_UID=$(get_host_uid)"
    "-e" "HOST_GID=$(get_host_gid)"
    "-e" "PLATFORM=$PLATFORM"
    "-e" "IS_CI=$IS_CI"
)

# Inject token securely
inject_token_securely "${CLAUDE_CODE_OAUTH_TOKEN}"

# Set up session state and dev caches
setup_session_state "$SESSION_NAME"
setup_dev_caches "$SESSION_NAME"

if $VERIFY_MODE; then
    DOCKER_ARGS+=("-e" "VERIFY_MODE=1")
fi

if $CONTINUE_SESSION; then
    DOCKER_ARGS+=("-e" "CONTINUE_SESSION=1")
fi

if $RUN_AS_USER; then
    DOCKER_ARGS+=("-e" "RUN_AS_USER=1")
fi

if $RUN_AS_ROOTISH; then
    DOCKER_ARGS+=("-e" "RUN_AS_ROOTISH=1")
    DOCKER_ARGS+=("--security-opt" "seccomp=unconfined")
fi

if $SHELL_ONLY; then
    DOCKER_ARGS+=("-e" "SHELL_ONLY=1")
fi

info "Starting container..."
echo "  Image: $IMAGE_NAME"
if $USE_GIT_SESSION; then
    echo "  Workspace: $GIT_SESSION_VOLUME -> /workspace (git session)"
else
    echo "  Workspace: $WORKSPACE_DIR -> /workspace"
fi
echo "  Platform: $PLATFORM"
echo "  State: claude-state-${SESSION_NAME}"
if $IS_CI; then
    echo "  CI Mode: enabled"
fi
if $USE_OVERLAY; then
    echo "  Session: $SESSION_VOLUME (overlay mode - deprecated)"
fi
if $USE_GIT_SESSION; then
    echo "  Git Session: $GIT_SESSION"
fi
echo ""

# Run container with entrypoint script
docker run "${DOCKER_ARGS[@]}" "$IMAGE_NAME" /bin/bash -c '
    set -e

    # Read token from securely mounted file
    export CLAUDE_CODE_OAUTH_TOKEN=$(cat /run/secrets/claude_token)

    HOST_UID=${HOST_UID:-1000}
    DEV_GID=61000

    # Set up overlayfs if requested
    if [[ "${USE_OVERLAY:-}" == "1" ]]; then
        echo "Setting up overlay filesystem..."
        mkdir -p /session-data/upper /session-data/work
        rmdir /workspace 2>/dev/null || rm -f /workspace 2>/dev/null || true
        mkdir -p /workspace
        if fuse-overlayfs \
            -o lowerdir=/workspace-lower,upperdir=/session-data/upper,workdir=/session-data/work \
            /workspace 2>&1; then
            echo "  Overlay mounted at /workspace"
        else
            mount --bind /workspace-lower /workspace 2>/dev/null || ln -sf /workspace-lower /workspace
            echo "  Fallback: direct mount, read-only"
        fi
        cd /workspace
        echo ""
    fi

    # Set up home directory
    mkdir -p /home/developer/.claude /home/developer/.cargo /home/developer/.npm /home/developer/.cache/pip

    # Create .claude.json with settings
    cat > /home/developer/.claude.json << EOF
{"theme":"dark-ansi","hasCompletedOnboarding":true,"bypassPermissionsModeAccepted":true}
EOF

    # Copy git config
    if [[ -f /root/.gitconfig ]]; then
        cp /root/.gitconfig /home/developer/.gitconfig 2>/dev/null || true
    fi

    if [[ "${RUN_AS_USER:-}" == "1" ]] || [[ "${RUN_AS_ROOTISH:-}" == "1" ]]; then
        groupadd -g $DEV_GID developer 2>/dev/null || true
        useradd -u $HOST_UID -g $DEV_GID -m -s /bin/bash developer 2>/dev/null || true
        chown -R developer:developer /home/developer
        chown developer:developer /workspace 2>/dev/null || true

        if [[ "${RUN_AS_ROOTISH:-}" == "1" ]]; then
            cat > /usr/local/bin/rootish << '\''WRAPPER'\''
#!/bin/bash
cmd=$(basename "$0")
if [[ "$cmd" != "rootish" ]]; then
    realcmd="${cmd%-rootish}"
    exec unshare --user --map-root-user -- "$realcmd" "$@"
else
    exec unshare --user --map-root-user -- "$@"
fi
WRAPPER
            chmod +x /usr/local/bin/rootish
            for cmd in apt apt-get dpkg; do
                ln -sf rootish /usr/local/bin/${cmd}-rootish
            done
            echo "rootish wrapper installed"
        fi
    fi

    # Verify mode
    if [[ "${VERIFY_MODE:-}" == "1" ]]; then
        echo "=== Verification ==="
        echo "Run as: $(if [[ "${RUN_AS_ROOTISH:-}" == "1" ]]; then echo "developer (sudo)"; elif [[ "${RUN_AS_USER:-}" == "1" ]]; then echo "developer"; else echo "root"; fi)"
        echo "Claude: $(which claude 2>&1)"
        echo "Platform: ${PLATFORM:-unknown}"

        echo ""
        echo "=== Token Check ==="
        if [[ -f /run/secrets/claude_token ]]; then
            echo "  Token file: OK"
            echo "  Token: ${CLAUDE_CODE_OAUTH_TOKEN:0:20}..."
        else
            echo "  Token file missing"
            exit 1
        fi

        echo ""
        echo "=== Claude Test ==="
        HOME=/home/developer claude --print "test" 2>&1 | head -5
        exit 0
    fi

    # Shell-only mode - just run bash in /workspace
    if [[ "${SHELL_ONLY:-}" == "1" ]]; then
        if [[ "${RUN_AS_USER:-}" == "1" ]] || [[ "${RUN_AS_ROOTISH:-}" == "1" ]]; then
            exec gosu developer bash -c "cd /workspace && exec bash"
        else
            exec bash -c "cd /workspace && exec bash"
        fi
    fi

    # Run claude
    if [[ "${RUN_AS_USER:-}" == "1" ]] || [[ "${RUN_AS_ROOTISH:-}" == "1" ]]; then
        CLAUDE_ARGS="--dangerously-skip-permissions"
    else
        CLAUDE_ARGS=""
    fi

    if [[ "${CONTINUE_SESSION:-}" == "1" ]]; then
        CLAUDE_ARGS="--continue $CLAUDE_ARGS"
    fi

    cd /workspace
    if [[ "${RUN_AS_USER:-}" == "1" ]] || [[ "${RUN_AS_ROOTISH:-}" == "1" ]]; then
        exec gosu developer claude $CLAUDE_ARGS
    else
        HOME=/home/developer exec claude $CLAUDE_ARGS
    fi
'

# Auto-sync on exit if configured
if [[ -n "$AUTO_SYNC_BRANCH" ]] && $USE_GIT_SESSION; then
    echo ""
    info "Auto-syncing session to branch: $AUTO_SYNC_BRANCH"
    "$0" --merge-session "$GIT_SESSION" --into "$AUTO_SYNC_BRANCH" --auto
fi

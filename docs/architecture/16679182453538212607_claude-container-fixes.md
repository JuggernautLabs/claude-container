# claude-container: Fixes Architecture

Design document for addressing all shortcomings and preparing for public release.

**Blocked by:** None
**Unlocks:** Public release, broader adoption

---

## Status

| Fix | Status | Commit | Notes |
|-----|--------|--------|-------|
| Fix 1: Zero-dep auth | ⏳ Pending | - | **NEXT** - Now unblocked by Fix 2 |
| Fix 2: Default base image | ✅ Done | (pending) | `Dockerfile.base`, `scripts/push-base-image` created |
| Fix 3: Git sessions | ✅ Done | (pending) | `--git-session`, `--diff-session`, `--merge-session` |
| Fix 4: Cross-platform | ✅ Done | 2471dee | Platform detection, CI support |
| Fix 5: Session persistence | ✅ Done | (pending) | `--session` flag for conversation history |
| Fix 6: Secure token | ✅ Done | 2471dee | File-based token injection |
| Fix 7: Cleanup commands | ✅ Done | 2471dee | `--cleanup`, `--list-sessions`, `--delete-session` |
| Fix 8: UX improvements | ✅ Done | 2471dee | Colors, `--version`, spinner |

**Progress: 7/8 fixes complete. Only Fix 1 (zero-dep auth) remains.**

### What's Been Built

```
scripts/claude-container     Main launcher (heavily modified)
├── --version               Version flag (0.1.0)
├── --session <name>        Persistent conversation history
├── --git-session <name>    Git-based isolated workspace
├── --diff-session <name>   Show changes vs original
├── --merge-session <name>  Apply session commits to repo
├── --cleanup               Remove all claude volumes
├── --list-sessions         List session volumes
├── --delete-session        Delete specific session
└── (default image fallback when no Dockerfile)

scripts/push-base-image      Push base image to ghcr.io
Dockerfile.base              Base image definition (Ubuntu + Node + Claude)
```

### To Push Base Image

```bash
cd ~/.hypermemetic-infra
./scripts/push-base-image        # Pushes ghcr.io/hypermemetic/claude-container:latest
./scripts/push-base-image v0.1.0 # Pushes with version tag
```

### Remaining Work: Fix 1 (Zero-Dep Auth)

When user runs `claude-container` without `CLAUDE_CODE_OAUTH_TOKEN`:
1. Pull default image (if no Dockerfile)
2. Run `claude setup-token` inside container
3. Capture token output
4. Save to `~/.config/claude-container/token`
5. Re-run with token

See Fix 1 section below for implementation details.

---

## Overview

This document details fixes for issues identified in `16679226435792340735_claude-container.md`.

```
Current State                          Target State
─────────────                          ────────────
Requires claude CLI on host     →      Zero dependencies (only Docker)
Requires Dockerfile             →      Default image fallback
Privileged mode for overlay     →      Git-based isolation (no privileges)
macOS-only                      →      Linux + Windows + CI/CD
No session persistence          →      Named sessions with merge workflow
Token in env var                →      Secure token injection
Manual cleanup                  →      Auto-cleanup + explicit commands
```

---

## Fix 1: Zero-Dependency Auth Flow

### Problem

User must have `claude` CLI installed on host to run `claude setup-token`.

```
scripts/claude-container:73-80
```

### Solution

Run auth flow inside a minimal container, capture token to host filesystem.

```
┌─────────────────────────────────────────────────────────────────┐
│ $ claude-container                                              │
│                                                                 │
│ No token found at ~/.config/claude-container/token              │
│                                                                 │
│ Starting authentication...                                      │
│ ════════════════════════════════════════════════════════════════│
│                                                                 │
│ Open this URL in your browser:                                  │
│ https://claude.ai/oauth/authorize?client_id=...                 │
│                                                                 │
│ Paste the code here: ________                                   │
│                                                                 │
│ ════════════════════════════════════════════════════════════════│
│ Token saved to ~/.config/claude-container/token                 │
│                                                                 │
│ Starting Claude Code...                                         │
└─────────────────────────────────────────────────────────────────┘
```

### Implementation

```bash
# New function in scripts/claude-container

acquire_token() {
    local token_file="$HOME/.config/claude-container/token"

    # Check existing token
    if [[ -f "$token_file" ]]; then
        CLAUDE_CODE_OAUTH_TOKEN=$(cat "$token_file")
        return 0
    fi

    # Check environment
    if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
        return 0
    fi

    echo "No token found. Starting authentication..."
    mkdir -p "$(dirname "$token_file")"

    # Run setup-token in container, mount token file location
    docker run -it --rm \
        -v "$HOME/.config/claude-container:/token-out" \
        "${DEFAULT_IMAGE}" \
        /bin/bash -c '
            claude setup-token 2>&1 | tee /dev/stderr | \
            grep -o "sk-ant-oat01-[A-Za-z0-9_-]*" | head -1 > /token-out/token
        '

    if [[ -f "$token_file" ]] && [[ -s "$token_file" ]]; then
        CLAUDE_CODE_OAUTH_TOKEN=$(cat "$token_file")
        echo "Token saved to $token_file"
        return 0
    else
        echo "Authentication failed"
        return 1
    fi
}
```

### Token Storage Locations

| Platform | Location | Notes |
|----------|----------|-------|
| macOS | `~/.config/claude-container/token` | Can also use Keychain via `security` |
| Linux | `~/.config/claude-container/token` | File permissions 600 |
| Windows | `%APPDATA%\claude-container\token` | Or WSL path |
| CI/CD | `CLAUDE_CODE_OAUTH_TOKEN` env var | No file storage |

### Files to Modify

- `scripts/claude-container` - Add `acquire_token()` function
- `scripts/claude-container` - Call before token check
- New: `scripts/claude-container-auth` - Standalone auth script (optional)

---

## Fix 2: Default Base Image

### Problem

User must have Dockerfile in project directory.

```
scripts/claude-container:82-97
```

### Solution

Publish base image, fall back when no Dockerfile found.

### Base Image Definition

```dockerfile
# Dockerfile.base (publish as ghcr.io/hypermemetic/claude-container:latest)

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# System dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    gosu \
    fuse-overlayfs \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Node.js 20
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Common dev tools (optional, increases image size)
RUN apt-get update && apt-get install -y \
    build-essential \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace
CMD ["claude"]
```

### Image Variants

| Tag | Size | Contents |
|-----|------|----------|
| `latest` / `slim` | ~500MB | Minimal: git, node, claude |
| `full` | ~1.5GB | + Python, build-essential, common langs |
| `rust` | ~2GB | + Rust toolchain |
| `python` | ~1GB | + Python dev tools |

### Implementation

```bash
# In scripts/claude-container

DEFAULT_IMAGE="ghcr.io/hypermemetic/claude-container:latest"

find_or_build_image() {
    # Try to find Dockerfile
    for candidate in "./Dockerfile" "./.devcontainer/Dockerfile" "./docker/Dockerfile"; do
        if [[ -f "$candidate" ]]; then
            DOCKERFILE="$candidate"
            break
        fi
    done

    if [[ -n "$DOCKERFILE" ]]; then
        # Build custom image
        IMAGE_NAME="claude-dev-${PROJECT_NAME}"
        if [[ -z "$(docker images -q "$IMAGE_NAME")" ]] || $FORCE_BUILD; then
            echo "Building image from $DOCKERFILE..."
            docker build -t "$IMAGE_NAME" -f "$DOCKERFILE" "$(dirname "$DOCKERFILE")"
        fi
    else
        # Use default image
        IMAGE_NAME="$DEFAULT_IMAGE"
        echo "No Dockerfile found, using default image: $IMAGE_NAME"

        # Pull if not present
        if [[ -z "$(docker images -q "$IMAGE_NAME")" ]]; then
            echo "Pulling $IMAGE_NAME..."
            docker pull "$IMAGE_NAME"
        fi
    fi
}
```

### Publishing Pipeline

```yaml
# .github/workflows/publish-image.yml

name: Publish Docker Image

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base
          push: true
          tags: |
            ghcr.io/hypermemetic/claude-container:latest
            ghcr.io/hypermemetic/claude-container:${{ github.ref_name }}
```

---

## Fix 3: Remove Privileged Mode

### Problem

Overlay mode requires `--privileged` which is a security concern.

```
scripts/claude-container:157-158
```

### Solution

Replace fuse-overlayfs with git-based isolation.

### Design: Git Worktree Sessions

```
┌─────────────────────────────────────────────────────────────────┐
│                     SESSION CREATION                             │
│                                                                 │
│  $ claude-container --session feature-x                         │
│                                                                 │
│  1. Create session volume: claude-session-feature-x             │
│  2. Clone repo into volume (shallow, no remotes)                │
│  3. Mount volume at /workspace                                  │
│  4. Claude works, makes commits                                 │
│  5. On exit, session persists in volume                         │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     SESSION MERGE                                │
│                                                                 │
│  $ claude-container --merge feature-x                           │
│                                                                 │
│  1. List commits in session                                     │
│  2. User selects commits to merge                               │
│  3. Cherry-pick to host repo                                    │
│  4. Optionally delete session                                   │
└─────────────────────────────────────────────────────────────────┘
```

### Implementation

```bash
# Session creation
create_session() {
    local name="$1"
    local source_dir="$2"
    local volume="claude-session-${name}"

    # Create volume
    docker volume create "$volume"

    # Clone repo into volume (strips remotes for safety)
    docker run --rm \
        -v "$source_dir:/source:ro" \
        -v "$volume:/session" \
        alpine/git \
        sh -c '
            git clone --depth=1 /source /session
            cd /session
            git remote remove origin 2>/dev/null || true
            git config user.email "claude@container"
            git config user.name "Claude"
        '

    echo "$volume"
}

# Session merge
merge_session() {
    local name="$1"
    local volume="claude-session-${name}"
    local target_dir="${2:-$(pwd)}"

    # Get commits from session
    commits=$(docker run --rm -v "$volume:/session" alpine/git \
        sh -c 'cd /session && git log --oneline origin/HEAD..HEAD 2>/dev/null || git log --oneline -10')

    echo "Commits in session '$name':"
    echo "$commits"
    echo ""
    read -p "Merge all commits? [y/n/select] " choice

    case $choice in
        y)
            # Export patches and apply
            docker run --rm \
                -v "$volume:/session:ro" \
                -v "$target_dir:/target" \
                alpine/git \
                sh -c '
                    cd /session
                    git format-patch --stdout origin/HEAD..HEAD | \
                    (cd /target && git am)
                '
            ;;
        # ... select mode, etc.
    esac
}
```

### Comparison: Overlay vs Git Sessions

| Aspect | Overlay (current) | Git Sessions (proposed) |
|--------|-------------------|-------------------------|
| Privileges | `--privileged` | None |
| History | File changes only | Full commit history |
| Merge | Copy files | Cherry-pick commits |
| Partial merge | Difficult | Per-commit selection |
| Disk usage | Copy-on-write | Full clone (can shallow) |
| Non-git repos | Works | Requires git |
| Speed | Fast (no clone) | Slower (clone on start) |

### Migration Path

1. Keep `--dir` for overlay (deprecated, requires explicit `--privileged` acceptance)
2. Add `--session <name>` for git-based isolation (recommended)
3. Eventually remove overlay support

---

## Fix 4: Cross-Platform Support

### Problem

macOS-specific code throughout.

```
scripts/claude-container:176-180 (SSH socket)
scripts/claude-container:228 (user creation)
```

### Solution

Platform detection and conditional logic.

```bash
# Platform detection
detect_platform() {
    case "$(uname -s)" in
        Darwin)
            PLATFORM="macos"
            ;;
        Linux)
            PLATFORM="linux"
            # Detect WSL
            if grep -qi microsoft /proc/version 2>/dev/null; then
                PLATFORM="wsl"
            fi
            ;;
        MINGW*|MSYS*|CYGWIN*)
            PLATFORM="windows"
            ;;
        *)
            PLATFORM="unknown"
            ;;
    esac
}

# Platform-specific SSH socket
get_ssh_socket_args() {
    case "$PLATFORM" in
        macos)
            echo "-v /run/host-services/ssh-auth.sock:/ssh-agent -e SSH_AUTH_SOCK=/ssh-agent"
            ;;
        linux|wsl)
            if [[ -n "${SSH_AUTH_SOCK:-}" ]]; then
                echo "-v $SSH_AUTH_SOCK:/ssh-agent -e SSH_AUTH_SOCK=/ssh-agent"
            fi
            ;;
        windows)
            # Windows named pipe - requires special handling
            echo ""
            ;;
    esac
}

# Platform-specific token storage
get_token_file() {
    case "$PLATFORM" in
        macos|linux|wsl)
            echo "$HOME/.config/claude-container/token"
            ;;
        windows)
            echo "$APPDATA/claude-container/token"
            ;;
    esac
}

# Dynamic UID (not hardcoded)
get_host_uid() {
    case "$PLATFORM" in
        windows)
            echo "1000"  # Default for Windows containers
            ;;
        *)
            id -u
            ;;
    esac
}
```

### CI/CD Support

```bash
# Detect CI environment
detect_ci() {
    if [[ -n "${CI:-}" ]] || [[ -n "${GITHUB_ACTIONS:-}" ]] || [[ -n "${GITLAB_CI:-}" ]]; then
        IS_CI=true
        # Disable TTY in CI
        DOCKER_TTY_ARGS=""
        # Token must come from env var in CI
        if [[ -z "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
            echo "Error: CLAUDE_CODE_OAUTH_TOKEN required in CI"
            exit 1
        fi
    else
        IS_CI=false
        DOCKER_TTY_ARGS="-it"
    fi
}
```

---

## Fix 5: Session Persistence

### Problem

Conversations lost when container exits.

### Solution

Mount `~/.claude` into a persistent volume per session.

```bash
# Session state volume
setup_session_state() {
    local session_name="${1:-default}"
    local state_volume="claude-state-${session_name}"

    # Create if not exists
    docker volume inspect "$state_volume" &>/dev/null || \
        docker volume create "$state_volume"

    # Add to docker args
    DOCKER_ARGS+=("-v" "$state_volume:/home/developer/.claude")
}
```

### Session State Contents

```
/home/developer/.claude/
├── projects/
│   └── <workspace-hash>/
│       ├── conversation.json    # Chat history
│       └── memory.md            # Long-term memory
├── settings.json                # User preferences
└── .credentials.json            # Cached auth (optional)
```

---

## Fix 6: Secure Token Handling

### Problem

Token visible in `docker inspect` and process list.

```
scripts/claude-container:188
```

### Solution

Use Docker secrets or file-based injection.

```bash
# Option 1: Docker secret (Swarm only)
# Not practical for single-container use

# Option 2: File mount (recommended)
inject_token_securely() {
    local token="$1"
    local tmpfile=$(mktemp)

    # Write token to temp file
    echo "$token" > "$tmpfile"
    chmod 600 "$tmpfile"

    # Mount as file, read inside container
    DOCKER_ARGS+=("-v" "$tmpfile:/run/secrets/claude_token:ro")

    # Container reads from file, not env
    # Modify entrypoint to: export CLAUDE_CODE_OAUTH_TOKEN=$(cat /run/secrets/claude_token)

    # Cleanup on exit
    trap "rm -f $tmpfile" EXIT
}
```

### Visibility Comparison

| Method | `docker inspect` | `ps aux` | `/proc/*/environ` |
|--------|------------------|----------|-------------------|
| `-e TOKEN=xxx` | Visible | Hidden | Visible |
| File mount | Hidden | Hidden | Hidden |
| Docker secret | Hidden | Hidden | Hidden |

---

## Fix 7: Cleanup Commands

### Problem

Orphaned volumes accumulate.

### Solution

Add explicit cleanup commands.

```bash
# In scripts/claude-container

case "$1" in
    --cleanup)
        echo "Cleaning up claude-container resources..."

        # List volumes
        volumes=$(docker volume ls -q | grep -E "^(claude-session-|claude-state-|session-data-)")

        if [[ -z "$volumes" ]]; then
            echo "No volumes to clean up"
            exit 0
        fi

        echo "Found volumes:"
        echo "$volumes" | sed 's/^/  /'
        echo ""

        read -p "Delete all? [y/n] " confirm
        if [[ "$confirm" == "y" ]]; then
            echo "$volumes" | xargs docker volume rm
            echo "Done"
        fi
        exit 0
        ;;

    --list-sessions)
        echo "Sessions:"
        docker volume ls -q | grep "^claude-session-" | sed 's/^claude-session-/  /'
        exit 0
        ;;

    --delete-session)
        session="$2"
        docker volume rm "claude-session-${session}" "claude-state-${session}" 2>/dev/null
        echo "Deleted session: $session"
        exit 0
        ;;
esac
```

---

## Fix 8: UX Improvements

### Color Output

```bash
# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info() { echo -e "${BLUE}→${NC} $*"; }
success() { echo -e "${GREEN}✓${NC} $*"; }
warn() { echo -e "${YELLOW}⚠${NC} $*"; }
error() { echo -e "${RED}✗${NC} $*" >&2; }

# Usage
info "Building image..."
success "Image built"
warn "No Dockerfile found, using default"
error "Authentication failed"
```

### Progress Indicators

```bash
# Spinner for long operations
spin() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while ps -p $pid &>/dev/null; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# Usage
docker build -t "$IMAGE_NAME" . &>/dev/null &
spin $!
wait $!
```

### Version Flag

```bash
VERSION="0.1.0"

case "$1" in
    --version|-V)
        echo "claude-container $VERSION"
        exit 0
        ;;
esac
```

---

## Implementation Order

```
                    ┌─────────────────┐
                    │   Fix 8: UX     │
                    │   ✅ DONE       │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  Fix 7: Cleanup │ │  Fix 4: Cross-  │ │  Fix 6: Secure  │
│  ✅ DONE        │ │  ✅ DONE        │ │  ✅ DONE        │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         └───────────────────┼───────────────────┘
                             │
         ┌───────────────────┼───────────────────┐
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  Fix 2: Default │ │  Fix 5: Session │ │  Fix 3: Git     │
│  ✅ DONE        │ │  ✅ DONE        │ │  ✅ DONE        │
└────────┬────────┘ └─────────────────┘ └─────────────────┘
         │
         ▼
┌─────────────────┐
│  Fix 1: Zero-   │  ← FINAL BLOCKER
│  dep auth       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  PUBLIC RELEASE │
└─────────────────┘
```

### Dependency DAG

| Fix | Blocked By | Unlocks | Status |
|-----|------------|---------|--------|
| Fix 8: UX | None | All others | ✅ Done |
| Fix 7: Cleanup | None | Fix 3, Fix 5 | ✅ Done |
| Fix 4: Cross-platform | None | Fix 1 | ✅ Done |
| Fix 6: Secure token | None | Fix 1 | ✅ Done |
| Fix 2: Default image | None | Fix 1 | ✅ Done |
| Fix 5: Session persistence | Fix 7 | Public release | ✅ Done |
| Fix 3: Git sessions | Fix 7 | Public release | ✅ Done |
| Fix 1: Zero-dep auth | Fix 2, Fix 4, Fix 6 | **Public release** | ⏳ **NEXT** |

---

## Testing Plan

### Unit Tests

```bash
# test/test-platform.sh
test_detect_platform() {
    source scripts/claude-container
    detect_platform
    assert_not_empty "$PLATFORM"
}

test_get_token_file() {
    source scripts/claude-container
    file=$(get_token_file)
    assert_match "$file" "claude-container/token"
}
```

### Integration Tests

```bash
# test/test-integration.sh

test_auth_flow() {
    # Mock OAuth server
    # Run auth flow
    # Assert token saved
}

test_session_create_merge() {
    # Create test repo
    # Create session
    # Make changes
    # Merge back
    # Assert changes in original
}

test_cleanup() {
    # Create volumes
    # Run --cleanup
    # Assert volumes removed
}
```

### Platform Matrix

| Test | macOS | Linux | WSL | CI |
|------|-------|-------|-----|-----|
| Auth flow | ✓ | ✓ | ✓ | ✓ |
| Direct mount | ✓ | ✓ | ✓ | ✓ |
| Git sessions | ✓ | ✓ | ✓ | ✓ |
| SSH forwarding | ✓ | ✓ | ? | N/A |
| Cleanup | ✓ | ✓ | ✓ | ✓ |

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `scripts/claude-container` | Modify | Add all fixes |
| `Dockerfile.base` | Create | Default base image |
| `.github/workflows/publish-image.yml` | Create | Image publishing |
| `.github/workflows/test.yml` | Create | CI testing |
| `test/test-*.sh` | Create | Test suites |
| `docs/CHANGELOG.md` | Create | Version history |
| `docs/CONTRIBUTING.md` | Create | Contribution guide |

---

## Estimated Effort

| Fix | Complexity | Time | Status |
|-----|------------|------|--------|
| Fix 8: UX | Low | 2 hours | ✅ Done |
| Fix 7: Cleanup | Low | 2 hours | ✅ Done |
| Fix 4: Cross-platform | Medium | 4 hours | ✅ Done |
| Fix 6: Secure token | Low | 2 hours | ✅ Done |
| Fix 2: Default image | Medium | 4 hours | ✅ Done |
| Fix 5: Session persistence | Medium | 4 hours | ✅ Done |
| Fix 3: Git sessions | High | 12 hours | ✅ Done |
| Fix 1: Zero-dep auth | High | 8 hours | ⏳ **NEXT** |

**Completed:** ~30 hours (7/8 fixes)
**Remaining:** ~8 hours (1 fix)

### Next Steps to Complete

1. **Push base image** (required before Fix 1 can work):
   ```bash
   cd ~/.hypermemetic-infra
   ./scripts/push-base-image
   ```

2. **Implement Fix 1** (zero-dep auth):
   - Modify `scripts/claude-container` to detect missing token
   - Run `claude setup-token` inside container when no token
   - Capture token and save to `~/.config/claude-container/token`
   - Auto-load token from file on subsequent runs

3. **Test full flow**:
   ```bash
   # New user experience (no token set):
   claude-container
   # → Pulls default image
   # → Runs auth flow
   # → Saves token
   # → Starts Claude
   ```

4. **Commit and tag release**:
   ```bash
   git add -A && git commit -m "feat: complete claude-container v0.1.0"
   git tag v0.1.0
   ```

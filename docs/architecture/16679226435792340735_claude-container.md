# claude-container Architecture

Containerized Claude Code execution with git-based isolation.

**Version:** 0.1.0
**Status:** 7/8 fixes complete, ready for public release after Fix 1

## Components

```
┌─────────────────────────────────────────────────────────────────┐
│                         Host Machine                            │
├─────────────────────────────────────────────────────────────────┤
│  scripts/claude-container     Main launcher (bash)              │
│  scripts/push-base-image      Push base image to ghcr.io        │
│  Dockerfile                   Project-specific image            │
│  Dockerfile.base              Default base image                │
│  crates/claude-daemon/        Rust programmatic client (WIP)    │
│  ~/.config/claude-container/  Token storage (cross-platform)    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Docker Container                           │
├─────────────────────────────────────────────────────────────────┤
│  /workspace              Project files (direct, git-session,    │
│                          or overlay mode)                       │
│  /home/developer/.claude Persistent state (conversation history)│
│  /run/secrets/claude_token  Secure token injection              │
│  ~/.claude.json          Theme + bypass settings                │
└─────────────────────────────────────────────────────────────────┘

Docker Volumes:
  claude-state-<session>    Conversation history per session
  claude-session-<name>     Git-based isolated workspaces
```

## File Locations

| File | Purpose | Code Reference |
|------|---------|----------------|
| `scripts/claude-container` | Main launcher | `codium --goto ~/.hypermemetic-infra/scripts/claude-container:1` |
| `Dockerfile` | Base image | `codium --goto ~/.hypermemetic-infra/Dockerfile:1` |
| `crates/claude-daemon/src/main.rs` | Rust CLI | `codium --goto ~/.hypermemetic-infra/crates/claude-daemon/src/main.rs:1` |
| `crates/claude-daemon/src/protocol.rs` | JSON types | `codium --goto ~/.hypermemetic-infra/crates/claude-daemon/src/protocol.rs:1` |
| `crates/claude-daemon/src/client.rs` | Message handling | `codium --goto ~/.hypermemetic-infra/crates/claude-daemon/src/client.rs:1` |
| `crates/claude-daemon/src/daemon.rs` | Container mgmt | `codium --goto ~/.hypermemetic-infra/crates/claude-daemon/src/daemon.rs:1` |

---

## Initialization Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           USER INVOCATION                                 │
│  $ CLAUDE_CODE_OAUTH_TOKEN=$(hyperforge secret get claude-code-token)    │
│  $ claude-container [--dir /path] [--build] [--verify]                   │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                         1. TOKEN CHECK                                    │
│  scripts/claude-container:73-80                                          │
│  ─────────────────────────────────────────────────────────────────────── │
│  if [[ -z "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then                        │
│      echo "Error: CLAUDE_CODE_OAUTH_TOKEN is required"                   │
│      exit 1                                                              │
│  fi                                                                      │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                       2. DOCKERFILE SEARCH                                │
│  scripts/claude-container:82-103                                         │
│  ─────────────────────────────────────────────────────────────────────── │
│  Search order:                                                           │
│    1. Explicit path argument                                             │
│    2. ./Dockerfile                                                       │
│    3. ./.devcontainer/Dockerfile                                         │
│    4. ./docker/Dockerfile                                                │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                        3. IMAGE BUILD                                     │
│  scripts/claude-container:117-124                                        │
│  ─────────────────────────────────────────────────────────────────────── │
│  IMAGE_NAME="claude-dev-${PROJECT_NAME}"                                 │
│  if [[ -z "$IMAGE_EXISTS" ]] || $FORCE_BUILD; then                       │
│      docker build -t "$IMAGE_NAME" -f "$DOCKERFILE" "$CONTEXT_DIR"       │
│  fi                                                                      │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                    4. MOUNT CONFIGURATION                                 │
│  ─────────────────────────────────────────────────────────────────────── │
│                                                                          │
│  ┌─────────────────────┐          ┌─────────────────────┐                │
│  │   Direct Mount      │          │   Overlay Mode      │                │
│  │   (default)         │          │   (--dir flag)      │                │
│  ├─────────────────────┤          ├─────────────────────┤                │
│  │ -v $PWD:/workspace  │          │ --privileged        │                │
│  │                     │          │ --device /dev/fuse  │                │
│  │ Changes persist     │          │ -v src:/workspace-  │                │
│  │ immediately         │          │     lower:ro        │                │
│  │                     │          │ -v session-data-    │                │
│  │                     │          │     uuid:/session-  │                │
│  │                     │          │     data            │                │
│  └─────────────────────┘          └─────────────────────┘                │
│                                                                          │
│  scripts/claude-container:155-166                                        │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                     5. CONTAINER STARTUP                                  │
│  scripts/claude-container:204-257                                        │
│  ─────────────────────────────────────────────────────────────────────── │
│                                                                          │
│  docker run "${DOCKER_ARGS[@]}" "$IMAGE_NAME" /bin/bash -c '             │
│                                                                          │
│    ┌─────────────────────────────────────────────────────────────────┐   │
│    │ 5a. OVERLAY SETUP (if --dir)                                    │   │
│    │     fuse-overlayfs -o lowerdir=/workspace-lower,                │   │
│    │                       upperdir=/session-data/upper,             │   │
│    │                       workdir=/session-data/work                │   │
│    │                       /workspace                                │   │
│    └─────────────────────────────────────────────────────────────────┘   │
│                              │                                           │
│                              ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────┐   │
│    │ 5b. USER CREATION                                               │   │
│    │     groupadd -g 61000 developer                                 │   │
│    │     useradd -u $HOST_UID -g 61000 developer                     │   │
│    └─────────────────────────────────────────────────────────────────┘   │
│                              │                                           │
│                              ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────┐   │
│    │ 5c. CONFIG CREATION                                             │   │
│    │     cat > ~/.claude.json << EOF                                 │   │
│    │     {"theme":"dark-ansi",                                       │   │
│    │      "hasCompletedOnboarding":true,                             │   │
│    │      "bypassPermissionsModeAccepted":true}                      │   │
│    │     EOF                                                         │   │
│    └─────────────────────────────────────────────────────────────────┘   │
│                              │                                           │
│                              ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────┐   │
│    │ 5d. CLAUDE EXECUTION                                            │   │
│    │     exec gosu developer claude --dangerously-skip-permissions   │   │
│    └─────────────────────────────────────────────────────────────────┘   │
│  '                                                                       │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Flag Reference

### `--build` / `-b`

Force rebuild Docker image even if it exists.

```
scripts/claude-container:23-26
```

### `--dir <path>` / `-d <path>`

Enable overlay mode for isolated workspace.

```
scripts/claude-container:27-30     # Argument parsing
scripts/claude-container:131-141   # Session volume creation
scripts/claude-container:155-166   # Mount configuration
scripts/claude-container:211-224   # Overlay mount inside container
```

**Flow:**
```
Source Directory ──────┐
     (read-only)       │
                       ▼
              ┌────────────────┐
              │ fuse-overlayfs │
              └────────────────┘
                       │
Session Volume ────────┤
  /session-data/upper  │
  (all writes here)    │
                       ▼
              ┌────────────────┐
              │   /workspace   │
              │ (merged view)  │
              └────────────────┘
```

### `--verify` / `-v`

Test container setup without running Claude.

```
scripts/claude-container:31-34     # Argument parsing
scripts/claude-container:245-252   # Verify logic
```

**Output:**
```
=== Verification ===
User: uid=501(developer) gid=61000(developer)
Claude: /usr/bin/claude
Token: sk-ant-oat01-8_Ln0u0...
[test response from claude --print]
```

---

## Execution Modes

### 1. Interactive TUI (Default)

```bash
CLAUDE_CODE_OAUTH_TOKEN=... claude-container
```

- Full terminal UI
- Runs `claude --dangerously-skip-permissions`
- TTY attached (`-it` flags)

```
scripts/claude-container:150-152   # TTY detection
scripts/claude-container:255-256   # exec claude
```

### 2. Print Mode (One-shot)

Not directly exposed by `claude-container`, but available via direct docker:

```bash
docker run --rm \
  -e "CLAUDE_CODE_OAUTH_TOKEN=$TOKEN" \
  -v "$(pwd):/workspace" \
  claude-dev-myproject \
  claude --print "your prompt here"
```

**Output:** Plain text response, no TUI.

### 3. Streaming JSON Mode (Programmatic)

For machine consumption:

```bash
echo '{"type":"user","message":{"role":"user","content":"list files"}}' | \
docker run --rm -i \
  -e "CLAUDE_CODE_OAUTH_TOKEN=$TOKEN" \
  -v "$(pwd):/workspace" \
  claude-dev-myproject \
  claude -p \
    --input-format stream-json \
    --output-format stream-json \
    --verbose \
    --dangerously-skip-permissions
```

**Protocol (crates/claude-daemon/src/protocol.rs):**

```
INPUT:
{"type":"user","message":{"role":"user","content":"..."}}

OUTPUT (newline-delimited JSON):
{"type":"system","subtype":"init","cwd":"/workspace",...}
{"type":"assistant","message":{"content":[{"type":"text","text":"..."}],...}}
{"type":"user","tool_use_result":{"stdout":"..."},...}
{"type":"result","is_error":false,"duration_ms":1234,...}
```

### 4. Daemon Mode (WIP)

Rust client for persistent sessions:

```bash
claude-daemon start              # Start container
claude-daemon send "do thing"    # Send message
claude-daemon chat               # Interactive REPL
claude-daemon stop               # Kill container
```

```
codium --goto ~/.hypermemetic-infra/crates/claude-daemon/src/main.rs:48
```

**Current limitations:**
- Doesn't truly daemonize (runs in foreground)
- Needs update for token-based auth
- No session persistence

---

## Authentication Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     HOST (one-time setup)                       │
│  $ claude setup-token                                           │
│  → Opens browser for OAuth                                      │
│  → Returns: sk-ant-oat01-...                                    │
│                                                                 │
│  $ hyperforge secret set claude-code-token <token>              │
│  → Stores in macOS Keychain                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     EACH INVOCATION                             │
│  $ export CLAUDE_CODE_OAUTH_TOKEN=$(hyperforge secret get       │
│        claude-code-token)                                       │
│  $ claude-container                                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     INSIDE CONTAINER                            │
│  CLAUDE_CODE_OAUTH_TOKEN env var passed via docker -e           │
│  Claude Code reads it, authenticates with Anthropic API         │
│  No files needed for auth                                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## Overlay Session Lifecycle

```
1. CREATE
   $ claude-container --dir ./myproject
   → Creates session-data-<uuid> volume
   → Source mounted read-only
   → Claude works in overlay

2. WORK
   Claude makes changes → written to /session-data/upper/
   Source directory unchanged

3. INSPECT
   $ docker volume ls | grep session-data
   session-data-abc123...

   $ docker run --rm -v session-data-abc123:/data alpine \
       ls -la /data/upper

4. MERGE (manual)
   $ docker run --rm -v session-data-abc123:/data -v $(pwd):/host alpine \
       cp -r /data/upper/* /host/

5. DISCARD
   $ docker volume rm session-data-abc123
```

---

## Dockerfile Requirements

Minimum viable Dockerfile:

```dockerfile
FROM rust:latest  # or any base

# Required: gosu for non-root execution
# Required: fuse-overlayfs for --dir mode
RUN apt-get update && apt-get install -y \
    git curl gosu fuse-overlayfs \
    && rm -rf /var/lib/apt/lists/*

# Node.js for Claude Code
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

WORKDIR /workspace
CMD ["claude"]
```

```
codium --goto ~/.hypermemetic-infra/Dockerfile:1
```

---

## Security Model

| Boundary | Protection |
|----------|------------|
| Token storage | macOS Keychain (encrypted, user-session bound) |
| Token in container | Environment variable (visible to container processes) |
| Workspace access | Mounted directory only |
| Network | Full access (no isolation) |
| Host filesystem | Only explicitly mounted paths |
| Privileged mode | Required for overlay (`--privileged`) |

**Risk: `--privileged` mode** grants container elevated capabilities. Mitigated by:
- Container is ephemeral (`--rm`)
- No persistent root access
- User runs as non-root inside container

---

## Current Shortcomings

### Critical (Blocking Public Release)

| Issue | Impact | Location |
|-------|--------|----------|
| **No guided auth flow** | User must have `claude` CLI on host to get token | `scripts/claude-container:73-80` |
| **No default image** | User must have Dockerfile in project | `scripts/claude-container:82-97` |
| **Privileged mode required** | Security concern for overlay; many users will reject | `scripts/claude-container:157-158` |
| **Hardcoded user ID** | Breaks on Linux with different UIDs | `scripts/claude-container:228` |
| **No Windows/Linux testing** | macOS-only keychain, SSH socket paths | `scripts/claude-container:176-180` |

### Significant (Poor UX)

| Issue | Impact | Location |
|-------|--------|----------|
| **No session persistence** | Conversations lost on container exit | N/A |
| **No merge workflow** | User must manually extract overlay changes | N/A |
| **Token in env var** | Visible in `docker inspect`, process list | `scripts/claude-container:188` |
| **No cleanup command** | Orphaned `session-data-*` volumes accumulate | N/A |
| **Daemon doesn't daemonize** | `claude-daemon start` blocks terminal | `crates/claude-daemon/src/main.rs:128-132` |
| **Silent failures** | Overlay mount failure falls back without warning | `scripts/claude-container:215-222` |

### Minor (Polish)

| Issue | Impact | Location |
|-------|--------|----------|
| **No progress indicators** | Image build gives no feedback | `scripts/claude-container:122` |
| **No color output** | Hard to scan output | Throughout |
| **hyperforge secret list incomplete** | Custom keys not shown | `bins/hyperforge:115-120` |
| **No version flag** | Can't check installed version | N/A |

---

## Public Release Readiness

### Phase 1: Minimal Viable Release

**Goal:** Works for users who have Claude CLI on host and a Dockerfile.

- [ ] Add `--version` flag
- [ ] Add color output (green success, red errors)
- [ ] Add progress spinners for image build
- [ ] Document clearly that `claude` CLI required on host
- [ ] Add `--cleanup` to remove orphaned session volumes
- [ ] Test on Linux (Ubuntu 22.04)

**Estimated scope:** ~2 days

### Phase 2: Zero-Dependency Startup

**Goal:** User can run `claude-container` with nothing pre-installed except Docker.

```
$ curl -fsSL https://raw.githubusercontent.com/.../install.sh | bash
$ claude-container
→ No token found. Starting auth flow...
→ [Opens browser, completes OAuth in container]
→ Token saved to ~/.config/claude-container/token
→ No Dockerfile found. Using default image...
→ Pulling ghcr.io/hypermemetic/claude-container:latest
→ Starting Claude Code...
```

**Requirements:**
- [ ] Publish base image to ghcr.io or Docker Hub
- [ ] Run `claude setup-token` inside container, capture token to host
- [ ] Store token in `~/.config/claude-container/token` (cross-platform)
- [ ] Fallback to default image when no Dockerfile
- [ ] Install script that adds to PATH

**Estimated scope:** ~1 week

### Phase 3: Remove Privileged Mode

**Goal:** Overlay mode works without `--privileged`.

Options:
1. **Use Docker volumes instead of overlay**
   - Copy source to volume on start
   - Slower but no privileges needed

2. **Use git worktrees**
   - `git worktree add` into volume
   - Requires source to be git repo

3. **Drop overlay, direct mount only**
   - Remove `--dir` flag entirely
   - Users who want isolation use git branches

**Recommended:** Option 3 for MVP, Option 2 for power users.

**Estimated scope:** ~3 days

### Phase 4: Session Persistence & Merge Workflow

**Goal:** Claude's work persists and can be reviewed/merged.

```
$ claude-container --session myfeature
→ Session 'myfeature' started
→ [Claude works...]

$ claude-container --list-sessions
  myfeature (2 hours ago, 3 commits)
  bugfix-123 (yesterday, 1 commit)

$ claude-container --diff myfeature
  [shows git diff of Claude's changes]

$ claude-container --merge myfeature
  → Cherry-picking 3 commits to current branch...
  → Done. Run 'git push' to publish.

$ claude-container --discard myfeature
  → Session 'myfeature' deleted.
```

**Requirements:**
- [ ] Git-based sessions (clone repo, strip remotes)
- [ ] Session metadata storage
- [ ] `--list-sessions`, `--diff`, `--merge`, `--discard` commands
- [ ] Daemon refactor for true background operation

**Estimated scope:** ~2 weeks

### Phase 5: Multi-Platform & CI/CD

**Goal:** Works everywhere, including GitHub Actions.

- [ ] Windows support (WSL2 or native)
- [ ] Linux ARM64 support
- [ ] GitHub Action for running Claude on PRs
- [ ] GitLab CI template
- [ ] Secrets via environment (for CI, not keychain)

**Estimated scope:** ~1 week

---

## Release Checklist

### Pre-Release

- [ ] All tests passing
- [ ] README with quick start
- [ ] Architecture doc (this file)
- [ ] CHANGELOG.md
- [ ] LICENSE (MIT or Apache-2.0)
- [ ] Contributing guide
- [ ] Code of conduct

### Release Artifacts

- [ ] GitHub release with binaries
- [ ] Docker image on ghcr.io
- [ ] Homebrew formula (macOS)
- [ ] AUR package (Arch Linux)
- [ ] Install script (curl | bash)

### Post-Release

- [ ] Announcement blog post
- [ ] Demo video
- [ ] Monitor issues for first 48 hours

---

## Future Work

1. **Guided onboarding**: Auto-detect missing token, run `claude setup-token` in container
2. **Default base image**: Publish `ghcr.io/hypermemetic/claude-container:latest`
3. **Git-based sessions**: Clone repo into session, strip remotes, merge via cherry-pick
4. **Daemon improvements**: True daemonization, session persistence, reconnection
5. **Commit workflow**: Post-exit prompt to commit changes
